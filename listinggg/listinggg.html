<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghor - Add Property</title>
    <link rel="stylesheet" href="add_property.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        #property-address {
            margin-bottom: 20px;
        }

        #property-description {
            padding: 10px 15px;
            border-radius: 8px;
        }

        .btn-primary.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn-primary.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- Your entire HTML content remains unchanged until the script part -->
    <!-- ... -->

    <!-- Mobile Menu Script -->
    <script>
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
        const mobileMenuClose = document.getElementById('mobileMenuClose');
        const propertyForm = {
            title: document.getElementById('property-title'),
            type: document.getElementById('property-type'),
            bedrooms: document.getElementById('bedrooms'),
            bathrooms: document.getElementById('bathrooms'),
            city: document.getElementById('city'),
            address: document.getElementById('property-address'),
            area: document.getElementById('area'),
            description: document.getElementById('property-description'),
            images: document.getElementById('property-images'),
            submit: document.getElementById('submit'),
            uploadPreview: document.getElementById('upload-preview')
        };

        let imageFiles = [];

        function checkAuthorization() {
            if (!(localStorage.getItem("token") && localStorage.getItem("KYC") == "Approved")) {
                window.alert("You need to login or verify your kyc for listing properties!");
                window.location.replace(localStorage.getItem("type") ? "/brokerpage" : "/landingpage");
            }
        }

        function toggleMobileMenu() {
            mobileMenu.classList.toggle('active');
            mobileMenuBtn.classList.toggle('active');
            mobileMenuOverlay.classList.toggle('active');
            document.body.classList.toggle('menu-open');
        }

        async function uploadSingleImage(file) {
            const formData = new FormData();
            formData.append("image", file);
            formData.append("id", localStorage.getItem("propertyinfo"));

            const response = await fetch("/upload", { method: "POST", body: formData });
            const data = await response.json();

            if (!response.ok) throw new Error(data.error);
            return data.imageUrl;
        }

        async function uploadImages() {
            const fileInput = propertyForm.images;

            if (!fileInput.files.length) {
                alert("Please select at least one image.");
                return;
            }
            if (fileInput.files.length > 5) {
                alert("Cannot upload more than 5 photos");
                return;
            }

            imageFiles = Array.from(fileInput.files);
            const uploadPromises = imageFiles.map(file => uploadSingleImage(file));

            try {
                const uploadedUrls = await Promise.all(uploadPromises);
                propertyForm.uploadPreview.innerText = "All images uploaded successfully!";
                window.alert("Property Listed Successfully");
                window.location.replace(localStorage.getItem("type") ? "/brokerpage" : "/landingpage");
            } catch (error) {
                console.error("Error:", error);
                propertyForm.uploadPreview.innerText = "Upload failed.";
            }
        }

        function setupAddressAutocomplete() {
            const suggestionsBox = document.getElementById('autocomplete-suggestions');

            propertyForm.address.addEventListener('input', function () {
                const query = this.value;

                if (!query) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                fetch(`/api/address-suggestions?query=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": localStorage.getItem("token")
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'OK' && data.predictions.length > 0) {
                            suggestionsBox.innerHTML = '';
                            suggestionsBox.style.display = 'block';

                            data.predictions.forEach(prediction => {
                                const li = document.createElement('li');
                                li.textContent = prediction.description;
                                li.onclick = function () {
                                    propertyForm.address.value = prediction.description;
                                    suggestionsBox.style.display = 'none';
                                };
                                suggestionsBox.appendChild(li);
                            });
                        } else {
                            suggestionsBox.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching suggestions:', error);
                        suggestionsBox.style.display = 'none';
                    });
            });
        }

        function handleFormSubmit(event) {
            event.preventDefault();

            const propertyData = {
                title: propertyForm.title.value,
                propertyType: propertyForm.type.value,
                bedrooms: propertyForm.bedrooms.value,
                bathrooms: propertyForm.bathrooms.value,
                city: propertyForm.city.value,
                location: propertyForm.address.value,
                area: propertyForm.area.value,
                description: propertyForm.description.value,
                amenities: [],
                Email: localStorage.getItem("Email")
            };

            const amenitiesCheckboxes = document.querySelectorAll('.amenities-container input[type="checkbox"]');
            amenitiesCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    propertyData.amenities.push(checkbox.value);
                }
            });

            fetch('/listing/propertyinfo', {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(propertyData)
            })
                .then(res => res.json())
                .then(ans => {
                    localStorage.setItem("propertyinfo", ans.PId);
                    uploadImages();
                });
        }

        function handleHomeNavigation(event) {
            event.preventDefault();
            window.location.href = localStorage.getItem('type') ? '/brokerpage' : '/landingpage';
        }

        document.addEventListener('DOMContentLoaded', function () {
            checkAuthorization();

            mobileMenuBtn.addEventListener('click', e => {
                e.stopPropagation();
                toggleMobileMenu();
            });

            mobileMenuClose.addEventListener('click', e => {
                e.stopPropagation();
                toggleMobileMenu();
            });

            mobileMenuOverlay.addEventListener('click', toggleMobileMenu);
            mobileMenu.addEventListener('click', e => e.stopPropagation());

            propertyForm.submit.addEventListener('click', function (e) {
                e.preventDefault();
                this.classList.add("loading");
                handleFormSubmit(e);
            });

            document.getElementById('home-link').addEventListener('click', handleHomeNavigation);
            document.getElementById('mobile-home-link').addEventListener('click', handleHomeNavigation);

            setupAddressAutocomplete();
        });
    </script>
</body>
</html>

